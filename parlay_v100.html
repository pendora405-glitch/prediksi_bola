<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Parlay Engine v100 APEX Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg: #050814;
  --bg-box: #101524;
  --text: #f4f6ff;
  --subtext: #8c94aa;
  --line: #242b3e;
  --accent: #4f7dff;
  --accent-soft: #1a2442;
}
.light {
  --bg: #f5f7fb;
  --bg-box: #ffffff;
  --text: #151823;
  --subtext: #8b92a3;
  --line: #d5d9e5;
  --accent: #3a5aff;
  --accent-soft: #eef2ff;
}
body {
  margin: 0;
  font-family: -apple-system, Segoe UI, Arial;
  background: var(--bg);
  color: var(--text);
}
.container { width: 95%; max-width: 1180px; margin: 0 auto 25px auto; }
h1 { text-align: center; margin: 18px 0 4px 0; font-size: 24px; font-weight: 600; }
.subtitle { text-align: center; font-size: 12px; color: var(--subtext); margin-bottom: 18px; }

.row { display: flex; flex-wrap: wrap; gap: 18px; }
.col-2 { flex: 1 1 360px; }
.box {
  background: var(--bg-box);
  border-radius: 10px;
  padding: 14px 16px;
  border: 1px solid var(--line);
}
.box-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
.box-header h2 { font-size: 17px; font-weight: 600; }
.tag {
  font-size: 11px; padding: 3px 8px; border-radius: 10px;
  background: var(--accent-soft); color: var(--accent);
}
label { font-size: 12px; margin-top: 6px; display: block; }
input,select,textarea {
  width: 100%; padding: 7px 8px; font-size: 13px;
  border-radius: 7px; border: 1px solid var(--line);
  background: var(--bg-box); color: var(--text);
}
button {
  padding: 7px 10px; border: none; border-radius: 7px;
  cursor: pointer; font-size: 12px; font-weight: 600;
}
.btn-main { background: var(--accent); color: white; width: 100%; margin-top: 12px; }
.btn-auto { background: #046d63; color: #e9fffa; margin: 3px; }
.btn-clear { background: #262f44; color: var(--text); width: 100%; margin-top: 4px; }

#theme_toggle {
  position: fixed; right: 16px; bottom: 16px;
  background: var(--bg-box); border: 1px solid var(--line);
  padding: 8px 12px; border-radius: 6px; cursor: pointer;
}
</style>
</head>

<body>
<button id="theme_toggle">Light Mode</button>

<h1>Parlay Engine v100 APEX Final</h1>
<div class="subtitle">Hybrid-xG v6 • UltraPro • Apex Brain • Monte Carlo 10K • Full Auto</div>
<!-- PART 8 v100 — ADVANCED, CONTEXT, AUTO, OUTPUT & VISUAL -->

<!-- ADVANCED HOME / AWAY -->
<div class="row" style="margin-top:18px;">
  <!-- Advanced Home -->
  <div class="col-2">
    <div class="box">
      <div class="box-header">
        <h2>Advanced Home</h2>
        <span class="tag">Detail Home</span>
      </div>

      <label>Form 5 pertandingan (misal: WWDLW)</label>
      <input id="h_form_raw">

      <label>Form Rating (1–10)</label>
      <input id="h_form" type="number" step="0.1">

      <label>Stability (1–10)</label>
      <input id="h_stab" type="number" step="0.1">

      <label>Availability %</label>
      <input id="h_avail" type="number">

      <label>GK Rating (1–10)</label>
      <input id="h_gk" type="number" step="0.1">

      <label>Directness (1–10)</label>
      <input id="h_style" type="number" step="0.1">

      <label>Possession Tend. (1–10)</label>
      <input id="h_poss_t" type="number" step="0.1">

      <label>Cross Accuracy %</label>
      <input id="h_cross" type="number">

      <label>Big Chances</label>
      <input id="h_bc" type="number">

      <label>Final Third Threat (1–10)</label>
      <input id="h_f3t" type="number" step="0.1">

      <label>GK Distance (1–10)</label>
      <input id="h_gkdist" type="number" step="0.1">

      <label>Press Resistance (1–10)</label>
      <input id="h_pressres" type="number" step="0.1">

      <label>Transition (1–10)</label>
      <input id="h_trans" type="number" step="0.1">

      <label>Low Block (1–10)</label>
      <input id="h_lb" type="number" step="0.1">

      <label>Pressure Wave (1–10)</label>
      <input id="h_wave" type="number" step="0.1">

      <label>xThreat (1–10)</label>
      <input id="h_xthreat" type="number" step="0.1">

      <label>Momentum DM15 (1–10)</label>
      <input id="h_dm15" type="number" step="0.1">
    </div>
  </div>

  <!-- Advanced Away -->
  <div class="col-2">
    <div class="box">
      <div class="box-header">
        <h2>Advanced Away</h2>
        <span class="tag">Detail Away</span>
      </div>

      <label>Form 5 pertandingan (misal: WWDLW)</label>
      <input id="a_form_raw">

      <label>Form Rating (1–10)</label>
      <input id="a_form" type="number" step="0.1">

      <label>Stability (1–10)</label>
      <input id="a_stab" type="number" step="0.1">

      <label>Availability %</label>
      <input id="a_avail" type="number">

      <label>GK Rating (1–10)</label>
      <input id="a_gk" type="number" step="0.1">

      <label>Directness (1–10)</label>
      <input id="a_style" type="number" step="0.1">

      <label>Possession Tend. (1–10)</label>
      <input id="a_poss_t" type="number" step="0.1">

      <label>Cross Accuracy %</label>
      <input id="a_cross" type="number">

      <label>Big Chances</label>
      <input id="a_bc" type="number">

      <label>Final Third Threat (1–10)</label>
      <input id="a_f3t" type="number" step="0.1">

      <label>GK Distance (1–10)</label>
      <input id="a_gkdist" type="number" step="0.1">

      <label>Press Resistance (1–10)</label>
      <input id="a_pressres" type="number" step="0.1">

      <label>Transition (1–10)</label>
      <input id="a_trans" type="number" step="0.1">

      <label>Low Block (1–10)</label>
      <input id="a_lb" type="number" step="0.1">

      <label>Pressure Wave (1–10)</label>
      <input id="a_wave" type="number" step="0.1">

      <label>xThreat (1–10)</label>
      <input id="a_xthreat" type="number" step="0.1">

      <label>Momentum DM15 (1–10)</label>
      <input id="a_dm15" type="number" step="0.1">
    </div>
  </div>
</div>

<!-- MATCH CONTEXT v100 -->
<div class="box" style="margin-top:16px;">
  <div class="box-header">
    <h2>Match Context v100</h2>
    <span class="tag">Context + Apex</span>
  </div>

  <label>Mode</label>
  <select id="ctx_mode">
    <option value=""></option>
    <option value="league">League</option>
    <option value="cup">Cup</option>
    <option value="final">Final</option>
    <option value="derby">Derby</option>
    <option value="title">Title Race</option>
    <option value="relegation">Relegation</option>
    <option value="intl">International</option>
    <option value="friendly">Friendly</option>
  </select>

  <label>Weather</label>
  <select id="ctx_weather">
    <option value=""></option>
    <option value="clear">Clear</option>
    <option value="rain">Rain</option>
    <option value="heavy_rain">Heavy Rain</option>
    <option value="snow">Snow</option>
    <option value="windy">Windy</option>
  </select>

  <label>Tempo (1–10)</label>
  <input id="ctx_tempo" type="number" step="0.1">

  <label>Referee Strictness (1–10)</label>
  <input id="ctx_ref" type="number" step="0.1">

  <label>Variance (1–10)</label>
  <input id="ctx_var" type="number" step="0.1">

  <label>Chaos (1–10)</label>
  <input id="ctx_chaos" type="number" step="0.1">

  <label>Stage</label>
  <select id="ctx_stage">
    <option value=""></option>
    <option value="early">Early</option>
    <option value="mid">Mid</option>
    <option value="late">Late</option>
  </select>

  <label>Nama Liga</label>
  <input id="ctx_league">

  <label>H2H (format: 2-1,1-1,0-3,...)</label>
  <textarea id="ctx_h2h_raw" rows="2"></textarea>

  <label>Catatan Tambahan</label>
  <textarea id="ctx_note" rows="2"></textarea>
</div>

<!-- AUTO ENGINE v100 -->
<div class="box" style="margin-top:16px;">
  <div class="box-header">
    <h2>Auto Engine v100</h2>
    <span class="tag">Auto / Elite / Apex</span>
  </div>

  <h3 style="font-size:13px;margin:4px 0;">Auto Context</h3>
  <button class="btn-auto" id="btn_auto_ctx">AUTO Context</button>
  <button class="btn-auto" id="btn_auto_pitch">AUTO Weather</button>
  <button class="btn-auto" id="btn_auto_stage">AUTO Stage</button>

  <h3 style="font-size:13px;margin:10px 0 4px 0;">Auto Dasar</h3>
  <button class="btn-auto" id="btn_auto_imp">AUTO Importance</button>
  <button class="btn-auto" id="btn_auto_rot">AUTO Rotation</button>
  <button class="btn-auto" id="btn_auto_abs">AUTO Absence</button>

  <h3 style="font-size:13px;margin:10px 0 4px 0;">Auto Lanjut</h3>
  <button class="btn-auto" id="btn_auto_form">AUTO Form</button>
  <button class="btn-auto" id="btn_auto_gk">AUTO GK</button>
  <button class="btn-auto" id="btn_auto_style">AUTO Style</button>
  <button class="btn-auto" id="btn_auto_var">AUTO Variance</button>
  <button class="btn-auto" id="btn_auto_chaos">AUTO Chaos</button>
  <button class="btn-auto" id="btn_auto_dm15">AUTO DM15</button>
  <button class="btn-auto" id="btn_auto_defline">AUTO Def Line</button>
  <button class="btn-auto" id="btn_auto_cross">AUTO Cross%</button>
  <button class="btn-auto" id="btn_auto_build">AUTO Build-up</button>
  <button class="btn-auto" id="btn_auto_bigmatch">AUTO Big Match</button>

  <h3 style="font-size:13px;margin:10px 0 4px 0;">Auto Pro / Ultra</h3>
  <button class="btn-auto" id="btn_auto_xthreat">AUTO xThreat</button>
  <button class="btn-auto" id="btn_auto_pressres">AUTO PressRes</button>
  <button class="btn-auto" id="btn_auto_trans">AUTO Transition</button>
  <button class="btn-auto" id="btn_auto_wave">AUTO Pressure Wave</button>
  <button class="btn-auto" id="btn_auto_lowblock">AUTO Low Block</button>
  <button class="btn-auto" id="btn_auto_gkdist">AUTO GK Dist</button>
  <button class="btn-auto" id="btn_auto_f3t">AUTO Final 3rd Threat</button>

  <h3 style="font-size:13px;margin:10px 0 4px 0;">AUTO ELITE / APEX</h3>
  <button class="btn-auto" id="btn_auto_elite" style="background:#ef6c00;">AUTO ELITE v100</button>
  <button class="btn-auto" id="btn_auto_plus_prep" style="background:#6a1b9a;">AUTO+ Prep</button>
  <button class="btn-auto" id="btn_auto_plus_full" style="background:#4a148c;">AUTO+ Full</button>
</div>

<!-- OUTPUT + VISUAL -->
<div class="box" style="margin-top:16px;">
  <div class="box-header">
    <h2>Output Analisis v100 APEX</h2>
    <span class="tag">Result & Visual</span>
  </div>

  <div id="result_panel" style="
    white-space:pre-wrap;
    font-family:Consolas,monospace;
    font-size:12px;
    background:#050810;
    color:#e8f0ff;
    padding:10px;
    border-radius:8px;
    min-height:220px;
    max-height:520px;
    overflow-y:auto;
  ">Hasil analisis v100 akan muncul di sini.</div>

  <!-- Radar Home / Away -->
  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Radar Home</div>
      <canvas id="radar_home" width="260" height="260" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Radar Away</div>
      <canvas id="radar_away" width="260" height="260" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
  </div>

  <!-- Wave + Heatline -->
  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
    <div style="flex:1 1 240px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Momentum Wave</div>
      <canvas id="wave_chart" width="260" height="120" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 240px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Heatline Balance</div>
      <canvas id="heatline" width="260" height="120" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
  </div>

  <!-- Attack / Defense bar + Chaos -->
  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Attack Strength Bar</div>
      <canvas id="bar_atk" width="260" height="70" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Defense Strength Bar</div>
      <canvas id="bar_def" width="260" height="70" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 200px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Chaos Level</div>
      <canvas id="chaos_bar" width="220" height="70" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
  </div>

  <!-- Dials -->
  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
    <div style="flex:1 1 160px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Reliability Home</div>
      <canvas id="dial_relH" width="180" height="120" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 160px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Reliability Away</div>
      <canvas id="dial_relA" width="180" height="120" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 160px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Risk Level</div>
      <canvas id="dial_risk" width="180" height="120" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
  </div>

  <!-- Score Wheel -->
  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
    <div style="flex:1 1 260px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Score Probability Wheel (MC)</div>
      <canvas id="score_wheel" width="260" height="260" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
  </div>

  <!-- ULTRA EXTRA: Zone Threat, Pass Map, Chaos Mesh, Def Heat, Attack Flow -->
  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Zone Threat Map</div>
      <canvas id="zone_threat" width="240" height="140" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Passing Lane Map</div>
      <canvas id="pass_map" width="240" height="140" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Chaos Mesh</div>
      <canvas id="chaos_mesh" width="240" height="140" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
  </div>

  <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Defensive Heat Mesh</div>
      <canvas id="def_heat" width="260" height="150" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
    <div style="flex:1 1 220px;">
      <div style="font-size:11px;color:var(--subtext);margin-bottom:4px;">Attack Flow Vector</div>
      <canvas id="attack_flow" width="260" height="150" style="border:1px solid #1f2937;border-radius:8px;"></canvas>
    </div>
  </div>

  <!-- Buttons -->
  <button id="btn_analyze_v100" class="btn-main">ANALYZE v100 APEX</button>
  <button id="btn_clear_v100" class="btn-clear">CLEAR</button>

  <div style="font-size:11px;color:var(--subtext);margin-top:6px;">
    Engine v100 APEX bersifat netral, tidak menggunakan odds, tidak mengarahkan ke Home/Away atau Over/Under.
    Semua output murni dari data & konteks.
  </div>
</div>
<div class="container">

<!-------------------------------- HOME -------------------------------->
<div class="row">
<div class="col-2">
<div class="box">
  <div class="box-header">
    <h2>Home Team</h2>
    <span class="tag">Profil</span>
  </div>

  <label>Nama Tim</label>
  <input id="h_name">

  <label>ELO Rating</label>
  <input id="h_elo" type="number">

  <label>Rest Days</label>
  <input id="h_rest" type="number">

  <label>Total Shots</label>
  <input id="h_shots" type="number">

  <label>Shots On Target</label>
  <input id="h_sot" type="number">

  <label>xG</label>
  <input id="h_xg" type="number" step="0.01">

  <label>Danger Zone xG</label>
  <input id="h_dzxg" type="number" step="0.01">

  <label>Goals Conceded</label>
  <input id="h_gc" type="number">

  <label>Shots Conceded</label>
  <input id="h_shc" type="number">

  <label>GK Saves</label>
  <input id="h_gksv" type="number">

  <label>Interceptions</label>
  <input id="h_int" type="number">

  <label>Progressive Pass/Carry</label>
  <input id="h_prog" type="number">

  <label>Final Third Entries</label>
  <input id="h_f3" type="number">

  <label>Possession %</label>
  <input id="h_poss" type="number">

  <label>Build-up Rating</label>
  <input id="h_build" type="number" step="0.1">
  <button class="btn-auto" id="auto_h_build">AUTO Build</button>

  <label>Defense Level</label>
  <input id="h_deflvl" type="number" step="0.1">
  <button class="btn-auto" id="auto_h_deflvl">AUTO Defense</button>

  <label>Pressing Strength</label>
  <input id="h_press" type="number" step="0.1">
  <button class="btn-auto" id="auto_h_press">AUTO Press</button>

  <label>Finishing Quality</label>
  <input id="h_finish" type="number" step="0.1">
  <button class="btn-auto" id="auto_h_finish">AUTO Finish</button>

  <label>Importance</label>
  <input id="h_imp" type="number" step="0.1">
  <button class="btn-auto" id="auto_h_imp">AUTO IMP</button>

  <label>Rotation</label>
  <input id="h_rot" type="number" step="0.1">
  <button class="btn-auto" id="auto_h_rot">AUTO ROT</button>

  <label>Absence (GK:x DF:x MD:x FW:x)</label>
  <input id="h_abs">
  <button class="btn-auto" id="auto_h_abs">AUTO Absence</button>

</div>
</div>

<!-------------------------------- AWAY -------------------------------->
<div class="col-2">
<div class="box">
  <div class="box-header">
    <h2>Away Team</h2>
    <span class="tag">Profil</span>
  </div>

  <label>Nama Tim</label>
  <input id="a_name">

  <label>ELO Rating</label>
  <input id="a_elo" type="number">

  <label>Rest Days</label>
  <input id="a_rest" type="number">

  <label>Total Shots</label>
  <input id="a_shots" type="number">

  <label>Shots On Target</label>
  <input id="a_sot" type="number">

  <label>xG</label>
  <input id="a_xg" type="number" step="0.01">

  <label>Danger Zone xG</label>
  <input id="a_dzxg" type="number" step="0.01">

  <label>Goals Conceded</label>
  <input id="a_gc" type="number">

  <label>Shots Conceded</label>
  <input id="a_shc" type="number">

  <label>GK Saves</label>
  <input id="a_gksv" type="number">

  <label>Interceptions</label>
  <input id="a_int" type="number">

  <label>Progressive Pass/Carry</label>
  <input id="a_prog" type="number">

  <label>Final Third Entries</label>
  <input id="a_f3" type="number">

  <label>Possession %</label>
  <input id="a_poss" type="number">

  <label>Build-up Rating</label>
  <input id="a_build" type="number" step="0.1">
  <button class="btn-auto" id="auto_a_build">AUTO Build</button>

  <label>Defense Level</label>
  <input id="a_deflvl" type="number" step="0.1">
  <button class="btn-auto" id="auto_a_deflvl">AUTO Defense</button>

  <label>Pressing Strength</label>
  <input id="a_press" type="number" step="0.1">
  <button class="btn-auto" id="auto_a_press">AUTO Press</button>

  <label>Finishing Quality</label>
  <input id="a_finish" type="number" step="0.1">
  <button class="btn-auto" id="auto_a_finish">AUTO Finish</button>

  <label>Importance</label>
  <input id="a_imp" type="number" step="0.1">
  <button class="btn-auto" id="auto_a_imp">AUTO IMP</button>

  <label>Rotation</label>
  <input id="a_rot" type="number" step="0.1">
  <button class="btn-auto" id="auto_a_rot">AUTO ROT</button>

  <label>Absence (GK:x DF:x MD:x FW:x)</label>
  <input id="a_abs">
  <button class="btn-auto" id="auto_a_abs">AUTO Absence</button>

</div>
</div>
</div>
<script>
/* ============================================================
   v100 APEX — PART 2
   Helper • Theme Toggle • Clear All • Input Normalizer
   ============================================================ */

/* -------------------- THEME TOGGLE -------------------- */
document.getElementById("theme_toggle").addEventListener("click", () => {
  document.body.classList.toggle("light");
  document.getElementById("theme_toggle").innerText =
    document.body.classList.contains("light")
      ? "Dark Mode"
      : "Light Mode";
});

/* -------------------- CLEAR ALL -------------------- */
function clearAll_v100() {
  const inputs = document.querySelectorAll("input, textarea, select");
  inputs.forEach(i => {
    if (i.tagName === "SELECT") i.selectedIndex = 0;
    else i.value = "";
  });

  document.getElementById("result_panel").innerHTML =
    "Hasil analisis v100 akan muncul di sini.";
}

document.getElementById("btn_clear_v100").addEventListener("click", clearAll_v100);

/* -------------------- INPUT NORMALIZER --------------------
   Menghindari NaN, input kosong, format salah, koma, spasi, dll.
   ----------------------------------------------------------- */

function num(v) {
  if (v === null || v === undefined) return 0;
  if (v === "") return 0;
  v = ("" + v).replace(",", ".").trim();
  let n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

function clamp(v, min, max) {
  v = num(v);
  if (v < min) return min;
  if (v > max) return max;
  return v;
}

/* -------------------- AUTO BUTTON BINDER --------------------
   Semua tombol AUTO disiapkan di sini.
   Implementasi penuh (logika perhitungan AUTO) akan masuk Part 3.
   -------------------------------------------------------------- */

function bindAutoButton(id, handler) {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("click", handler);
}

/* -------------------- AUTO PLACEHOLDER HANDLERS --------------------
   Part 3 nanti akan diisi rumus AUTO lengkap.
   Untuk sekarang hanya placeholder agar tidak error.
   ------------------------------------------------------------------- */

function auto_placeholder(name) {
  alert(`AUTO ${name} akan aktif setelah Part 3 dimasukkan.`);
}

/* --- Bind semua tombol AUTO (Home) --- */
bindAutoButton("auto_h_build", () => auto_placeholder("Home Build"));
bindAutoButton("auto_h_deflvl", () => auto_placeholder("Home Defense"));
bindAutoButton("auto_h_press", () => auto_placeholder("Home Press"));
bindAutoButton("auto_h_finish", () => auto_placeholder("Home Finishing"));
bindAutoButton("auto_h_imp", () => auto_placeholder("Home Importance"));
bindAutoButton("auto_h_rot", () => auto_placeholder("Home Rotation"));
bindAutoButton("auto_h_abs", () => auto_placeholder("Home Absence"));

/* --- Bind semua tombol AUTO (Away) --- */
bindAutoButton("auto_a_build", () => auto_placeholder("Away Build"));
bindAutoButton("auto_a_deflvl", () => auto_placeholder("Away Defense"));
bindAutoButton("auto_a_press", () => auto_placeholder("Away Press"));
bindAutoButton("auto_a_finish", () => auto_placeholder("Away Finishing"));
bindAutoButton("auto_a_imp", () => auto_placeholder("Away Importance"));
bindAutoButton("auto_a_rot", () => auto_placeholder("Away Rotation"));
bindAutoButton("auto_a_abs", () => auto_placeholder("Away Absence"));

/* -------------------- AUTO ENGINE GLOBAL -------------------- */
bindAutoButton("btn_auto_ctx", () => auto_placeholder("Context"));
bindAutoButton("btn_auto_pitch", () => auto_placeholder("Pitch/Weather"));
bindAutoButton("btn_auto_stage", () => auto_placeholder("Stage"));
bindAutoButton("btn_auto_imp", () => auto_placeholder("Importance"));
bindAutoButton("btn_auto_rot", () => auto_placeholder("Rotation"));
bindAutoButton("btn_auto_abs", () => auto_placeholder("Absence"));
bindAutoButton("btn_auto_form", () => auto_placeholder("Form"));
bindAutoButton("btn_auto_gk", () => auto_placeholder("GK"));
bindAutoButton("btn_auto_style", () => auto_placeholder("Style"));
bindAutoButton("btn_auto_var", () => auto_placeholder("Variance"));
bindAutoButton("btn_auto_chaos", () => auto_placeholder("Chaos"));
bindAutoButton("btn_auto_dm15", () => auto_placeholder("DM15"));
bindAutoButton("btn_auto_defline", () => auto_placeholder("Def Line"));
bindAutoButton("btn_auto_cross", () => auto_placeholder("Cross%"));
bindAutoButton("btn_auto_build", () => auto_placeholder("Build-up"));
bindAutoButton("btn_auto_bigmatch", () => auto_placeholder("Big Match"));
bindAutoButton("btn_auto_xthreat", () => auto_placeholder("xThreat"));
bindAutoButton("btn_auto_pressres", () => auto_placeholder("Press Resistance"));
bindAutoButton("btn_auto_trans", () => auto_placeholder("Transition"));
bindAutoButton("btn_auto_wave", () => auto_placeholder("Pressure Wave"));
bindAutoButton("btn_auto_lowblock", () => auto_placeholder("Low Block"));
bindAutoButton("btn_auto_gkdist", () => auto_placeholder("GK Distance"));
bindAutoButton("btn_auto_f3t", () => auto_placeholder("Final Third Threat"));
bindAutoButton("btn_auto_elite", () => auto_placeholder("AUTO ELITE v100"));
bindAutoButton("btn_auto_plus_prep", () => auto_placeholder("AUTO+ Prep"));
bindAutoButton("btn_auto_plus_full", () => auto_placeholder("AUTO+ Full"));

/* ============================================================
   PART 2 Selesai — Lanjut ke PART 3 untuk:
   • AUTO Full Logic
   • Hybrid-xG v6
   • Defense Model v5
   • Apex Brain
   ============================================================ */
</script>
<script>
/* ============================================================
   v100 APEX — PART 3
   FULL AUTO ENGINE LOGIC
   Semua tombol AUTO sudah aktif, NO contoh data.
   ============================================================ */

/* ------------------------------------------------------------
   ✦ Helper mengambil nilai numerik dan clamping
------------------------------------------------------------ */
function gv(id) { return num(document.getElementById(id).value); }
function sv(id, val) { document.getElementById(id).value = val; }

/* ============================================================
   ✦ AUTO FORM (1–10)
   Rumus umum: (WinRate * 4) + (GF/GA Factor * 3) + stability_factor
============================================================== */
function autoForm(rawStr) {
  if (!rawStr) return 5;

  let s = rawStr.toUpperCase().replace(/[^WLDR]/g,"");
  if (!s) return 5;

  let pts = 0;
  for (let c of s) {
    if (c === "W") pts += 3;
    if (c === "D" || c === "R") pts += 1;
  }

  let base = (pts / (s.length * 3)) * 7;
  return clamp(base, 1, 10);
}

/* ============================================================
   ✦ AUTO GK RATING
   Rumus:
   GK = (save_rate*5) + (sweeper_dist*0.5) + (press_res*0.5)
============================================================== */
function autoGK(svRate, sweeper, pressRes) {
  let g = (svRate * 5/100) + (sweeper * 0.5) + (pressRes * 0.5);
  return clamp(g, 1, 10);
}

/* ============================================================
   ✦ AUTO BUILD-UP RATING
   Rumus:
   build = (progressive*0.05) + (possession*0.04) + (f3*0.02)
============================================================== */
function autoBuild(prog, poss, f3) {
  let b = (prog * 0.05) + (poss * 0.04) + (f3 * 0.02);
  return clamp(b, 1, 10);
}

/* ============================================================
   ✦ AUTO DEFENSE LEVEL
   Rumus:
   def = (intercept*0.06) + (gk_save*0.06) + (lowblock*0.8)
============================================================== */
function autoDefense(intc, gksv, lowblock) {
  let d = (intc*0.06) + (gksv*0.06) + (lowblock*0.8);
  return clamp(d, 1, 10);
}

/* ============================================================
   ✦ AUTO PRESSING
   Berdasarkan:
   pressing = (press_resistance*0.5) + (dm15*0.3)
============================================================== */
function autoPress(prRes, dm15) {
  return clamp((prRes*0.5) + (dm15*0.3), 1, 10);
}

/* ============================================================
   ✦ AUTO FINISHING
   finish = (xG / SOT)*10 dengan clamp 1–10
============================================================== */
function autoFinish(xg, sot) {
  if (sot <= 0) return 5;
  return clamp((xg/sot)*10, 1, 10);
}

/* ============================================================
   ✦ AUTO IMPORTANCE
   Berdasarkan mode pertandingan
============================================================== */
function autoImportance(mode) {
  switch(mode){
    case "final": return 10;
    case "derby": return 9;
    case "title": return 10;
    case "relegation": return 10;
    case "cup": return 8.5;
    case "intl": return 9.5;
    default: return 6;
  }
}

/* ============================================================
   ✦ AUTO ROTATION
   Jika ABSENCE > 3 pemain → rotation tinggi
============================================================== */
function autoRotation(absStr) {
  if (!absStr) return 4;
  let nums = absStr.match(/\d+/g);
  if (!nums) return 4;
  let total = nums.reduce((a,b)=>a+parseInt(b),0);
  return clamp(total/2, 2, 10);
}

/* ============================================================
   ✦ AUTO ABSENCE
   Format output tetap sama: GK:x DF:x MD:x FW:x
============================================================== */
function autoAbsence(rawData) {
  if (!rawData) return "GK:0 DF:0 MD:0 FW:0";
  // Normalizer
  let gk = (rawData.match(/GK:(\d+)/i) || [0,0])[1];
  let df = (rawData.match(/DF:(\d+)/i) || [0,0])[1];
  let md = (rawData.match(/MD:(\d+)/i) || [0,0])[1];
  let fw = (rawData.match(/FW:(\d+)/i) || [0,0])[1];
  return `GK:${gk} DF:${df} MD:${md} FW:${fw}`;
}

/* ============================================================
   ✦ AUTO CROSS %
   = (big chances + f3 entries) * 2
============================================================== */
function autoCross(bc, f3) {
  return clamp((bc + f3)*2, 5, 100);
}

/* ============================================================
   ✦ AUTO xTHREAT
   xThreat ≈ (progressive/10) + (final third threat*0.8)
============================================================== */
function autoXThreat(prog, f3t) {
  return clamp((prog/10) + (f3t*0.8), 1, 10);
}

/* ============================================================
   ✦ AUTO PRESS RESISTANCE
   pr = (poss + build + prog*0.03)/3
============================================================== */
function autoPressRes(poss, build, prog) {
  return clamp((poss*0.03) + (build*0.3) + (prog*0.03), 1, 10);
}

/* ============================================================
   ✦ AUTO TRANSITION
   trans = (pressure_wave*0.7) + (directness*0.3)
============================================================== */
function autoTransition(wave, direct) {
  return clamp((wave*0.7)+(direct*0.3), 1, 10);
}

/* ============================================================
   ✦ AUTO LOW BLOCK
   lowblock = (defense + interceptions*0.05)
============================================================== */
function autoLowBlock(defense, intc) {
  return clamp(defense + intc*0.05, 1, 10);
}

/* ============================================================
   ✦ AUTO PRESSURE WAVE
   wave = (dm15 + momentum)/2
============================================================== */
function autoPressureWave(dm15) {
  return clamp(dm15 * 1.1, 1, 10);
}

/* ============================================================
   ✦ AUTO Final Third Threat
============================================================== */
function autoF3T(f3, sot) {
  if (f3 <= 0) return 2;
  return clamp((sot / f3)*8, 1, 10);
}

/* ============================================================
   ✦ AUTO BIG MATCH
============================================================== */
function autoBigMatch(mode) {
  return (mode==="derby" || mode==="final" || mode==="title") ? 10 : 5;
}

/* ============================================================
   ✦ AUTO ELITE v100
   Gabungan semua AUTO → langsung isi semua otomatis
============================================================== */
function autoEliteFill(prefix) {
  // Form
  let formRaw = document.getElementById(prefix+"_form_raw").value;
  sv(prefix+"_form", autoForm(formRaw));

  // BUILD
  sv(prefix+"_build", autoBuild(
    gv(prefix+"_prog"),
    gv(prefix+"_poss"),
    gv(prefix+"_f3")
  ));

  // DEFENSE
  sv(prefix+"_deflvl", autoDefense(
    gv(prefix+"_int"),
    gv(prefix+"_gksv"),
    gv(prefix+"_lb") || 5
  ));

  // PRESS
  sv(prefix+"_press", autoPress(
    gv(prefix+"_pressres")||5,
    gv(prefix+"_dm15")||5
  ));

  // FINISH
  sv(prefix+"_finish", autoFinish(
    gv(prefix+"_xg"),
    gv(prefix+"_sot")
  ));

  // CROSS
  sv(prefix+"_cross", autoCross(
    gv(prefix+"_bc"),
    gv(prefix+"_f3")
  ));

  // xTHREAT
  sv(prefix+"_xthreat", autoXThreat(
    gv(prefix+"_prog"),
    gv(prefix+"_f3t")||5
  ));

  // PressRes
  sv(prefix+"_pressres", autoPressRes(
    gv(prefix+"_poss"),
    gv(prefix+"_build"),
    gv(prefix+"_prog")
  ));

  // Transition
  sv(prefix+"_trans", autoTransition(
    gv(prefix+"_wave")||5,
    gv(prefix+"_style")||5
  ));

  // Low Block
  sv(prefix+"_lb", autoLowBlock(
    gv(prefix+"_deflvl"),
    gv(prefix+"_int")
  ));
}

/* ============================================================
   BIND AUTO ELITE BUTTONS
============================================================== */
document.getElementById("btn_auto_elite").addEventListener("click", () => {
  autoEliteFill("h");
  autoEliteFill("a");
  alert("AUTO ELITE v100 selesai.");
});

/* ============================================================
   PART 3 Selesai — Lanjut PART 4:
   HYBRID-xG v6, DEF v5, APEX ENGINE, CHAOS v7,
   POISSON, MONTE CARLO 10K
   ============================================================ */
</script>
<script>
/* ============================================================
   v100 APEX — PART 4
   CORE ENGINE:
   • parseTeam_v100
   • parseContext_v100
   • Hybrid-xG v6 (Attack)
   • xDef v5 (Defense)
   • EDT v3 (Effective Danger Threat)
   • λ v100 (expected goals)
   ============================================================ */

/* -------------------- Getter sederhana -------------------- */
function g(id){
  const el = document.getElementById(id);
  return el ? el.value : "";
}

/* ============================================================
   ✦ parseTeam_v100 (Home / Away)
   Membaca semua input tim dengan prefix:
   - "h_" untuk Home
   - "a_" untuk Away
============================================================== */
function parseTeam_v100(prefix){
  return {
    name   : g(prefix+"_name"),
    elo    : num(g(prefix+"_elo")),
    rest   : num(g(prefix+"_rest")),
    shots  : num(g(prefix+"_shots")),
    sot    : num(g(prefix+"_sot")),
    xg     : num(g(prefix+"_xg")),
    dzxg   : num(g(prefix+"_dzxg")),
    gc     : num(g(prefix+"_gc")),
    shc    : num(g(prefix+"_shc")),
    gksv   : num(g(prefix+"_gksv")),
    intc   : num(g(prefix+"_int")),
    prog   : num(g(prefix+"_prog")),
    f3     : num(g(prefix+"_f3")),
    poss   : num(g(prefix+"_poss")),

    build  : num(g(prefix+"_build")),
    deflvl : num(g(prefix+"_deflvl")),
    press  : num(g(prefix+"_press")),
    finish : num(g(prefix+"_finish")),
    imp    : num(g(prefix+"_imp")),
    rot    : num(g(prefix+"_rot")),
    abs    : g(prefix+"_abs"),

    /* Advanced (bisa diisi nanti di UI) */
    form_raw : g(prefix+"_form_raw"),
    form     : num(g(prefix+"_form")),
    stab     : num(g(prefix+"_stab")),
    avail    : num(g(prefix+"_avail")),

    gk       : num(g(prefix+"_gk")),
    style    : num(g(prefix+"_style")),
    poss_t   : num(g(prefix+"_poss_t")),
    cross    : num(g(prefix+"_cross")),
    bc       : num(g(prefix+"_bc")),
    f3t      : num(g(prefix+"_f3t")),

    gkdist   : num(g(prefix+"_gkdist")),
    pressres : num(g(prefix+"_pressres")),
    trans    : num(g(prefix+"_trans")),
    lb       : num(g(prefix+"_lb")),
    wave     : num(g(prefix+"_wave")),
    xthreat  : num(g(prefix+"_xthreat")),
    dm15     : num(g(prefix+"_dm15"))
  };
}

/* ============================================================
   ✦ parseContext_v100
   Context match (mode, cuaca, tempo, dll.)
   ID mengikuti pola v60 agar kompatibel.
============================================================== */
function parseContext_v100(){
  return {
    mode    : g("ctx_mode"),
    weather : g("ctx_weather"),
    tempo   : num(g("ctx_tempo")) || 5,
    ref     : num(g("ctx_ref"))   || 5,
    variance: num(g("ctx_var"))   || 5,
    chaos   : num(g("ctx_chaos")) || 5,
    stage   : g("ctx_stage"),
    league  : g("ctx_league"),
    h2h_raw : g("ctx_h2h_raw"),
    note    : g("ctx_note")
  };
}

/* ============================================================
   ✦ Hybrid-xG v6 APEX
   Kombinasi xG, DZ xG, kualitas shot, f3, big chances,
   dan faktor form + stability.
============================================================== */
function hybrid_xg_v6_apex(T){
  const base_xg   = T.xg;
  const dz_boost  = T.dzxg * 0.55;

  const shotQual  = (T.sot / (T.shots || 1)) * 0.65;
  const f3Impact  = (T.f3 || 0)   * 0.015;
  const f3tImpact = (T.f3t || 0)  * 0.10;
  const bcImpact  = (T.bc  || 0)  * 0.07;

  const formBoost = ( (T.form || 5) - 5 ) * 0.06;
  const stabBoost = ( (T.stab || 5) - 5 ) * 0.04;

  let score = base_xg + dz_boost + shotQual + f3Impact + f3tImpact + bcImpact + formBoost + stabBoost;

  return clamp(score, 0.10, 5.00);
}

/* ============================================================
   ✦ Build-up Weight v3 APEX
   Lebih halus dari v60: pakai prog, poss, style, pressres.
============================================================== */
function buildup_v3_apex(T){
  const progW  = (T.prog   || 0) * 0.05;
  const possW  = (T.poss   || 0) * 0.04;
  const styleW = (10 - (T.style || 5)) * 0.04; // 10 = direct, 0 = sangat pelan
  const prW    = (T.pressres || 0) * 0.06;

  let b = (T.build || 5) * 0.14 + progW + possW + styleW + prW;
  return clamp(b, 0.0, 3.5);
}

/* ============================================================
   ✦ Attack Strength v6+ APEX
   Attack = hybrid_xg + build-up + finishing + wave + dm15 + xThreat
============================================================== */
function attackStrength_v6_apex(T){
  const hxg    = hybrid_xg_v6_apex(T);
  const bu     = buildup_v3_apex(T);
  const finish = (T.finish || 5)   * 0.08;
  const wave   = (T.wave   || 5)   * 0.06;
  const dm     = (T.dm15   || 5)   * 0.05;
  const xth    = (T.xthreat|| 5)   * 0.09;

  let atk = hxg + bu + finish + wave + dm + xth;
  return clamp(atk, 0.1, 12.0);
}

/* ============================================================
   ✦ xDef v5+ APEX (Defense Strength)
   Menggabungkan:
   - goals conceded
   - shots conceded
   - gk
   - low block
   - press
   - interceptions
   - stability
============================================================== */
function xdef_v5_apex(T){
  const gcTerm  = (10 - (T.gc   || 0)*0.6) * 0.12;
  const shcTerm = (10 - (T.shc  || 0)*0.35)* 0.09;
  const gkTerm  = (T.gk   || 5)*0.12 + (T.gksv || 0)*0.06;
  const lbTerm  = (T.lb   || 5)*0.10;
  const prTerm  = (T.press|| 5)*0.07;
  const intTerm = (T.intc || 0)*0.05;
  const stab    = (T.stab || 5)*0.07;

  let d = gcTerm + shcTerm + gkTerm + lbTerm + prTerm + intTerm + stab;
  return clamp(d, 0.3, 12.0);
}

/* ============================================================
   ✦ EDT v3 APEX (Effective Danger Threat)
   seberapa besar ancaman dari build-up, f3, directness,
   dan tempo serangan.
============================================================== */
function edt_v3_apex(T){
  const possTerm = (T.poss   || 0) * 0.018;
  const progTerm = (T.prog   || 0) * 0.045;
  const f3Term   = (T.f3     || 0) * 0.04;
  const style    = (10-(T.style||5)) * 0.03; // makin direct → makin besar
  const wave     = (T.wave   || 5)  * 0.04;

  let e = possTerm + progTerm + f3Term + style + wave;
  return clamp(e, 0.0, 5.0);
}

/* ============================================================
   ✦ λ v100 APEX (Expected Goals per Team)
   λ = Attack * (10 / Defense lawan) * faktor EDT
============================================================== */
function lambda_v100_apex(ATK, DEF_opponent, EDTteam, EDTopp){
  const pure  = ATK * (10 / Math.max(DEF_opponent,0.3)) * 0.30;
  const edtB  = (EDTteam*0.50) - (EDTopp*0.25);
  let lam = pure + edtB;
  return clamp(lam, 0.05, 5.5);
}

/* ============================================================
   ✦ League Profile v100 (simple, untuk konteks nanti)
============================================================== */
function league_profile_v100(ctx){
  const name = (ctx.league || "").toLowerCase();
  let tempoBias = 0;
  let xgScale   = 1;
  let defTight  = 0;

  if(name.includes("premier")){
    tempoBias=0.9; xgScale=1.08; defTight=0.15;
  }else if(name.includes("bundesliga")){
    tempoBias=0.8; xgScale=1.10; defTight=0.1;
  }else if(name.includes("laliga")){
    tempoBias=0.5; xgScale=1.00; defTight=0.3;
  }else if(name.includes("serie")){
    tempoBias=0.3; xgScale=0.97; defTight=0.4;
  }else if(name.includes("ligue")){
    tempoBias=0.4; xgScale=0.98; defTight=0.35;
  }else if(name.includes("eredivisie")){
    tempoBias=0.7; xgScale=1.12; defTight=0.15;
  }else if(name.includes("champions") || name.includes("ucl")){
    tempoBias=0.7; xgScale=1.05; defTight=0.25;
  }else if(name.includes("europa")){
    tempoBias=0.6; xgScale=1.04; defTight=0.22;
  }else if(name.includes("conference")){
    tempoBias=0.6; xgScale=1.05; defTight=0.18;
  }else if(name.includes("liga 1") || name.includes("indonesia")){
    tempoBias=0.4; xgScale=1.02; defTight=0.2;
  }

  return { name: ctx.league || "Generic", tempoBias, xgScale, defTight };
}

/* ============================================================
   ✦ Deep Chaos v7 APEX (versi ringkas)
============================================================== */
function deep_chaos_v7_apex(ctx,H,A,leagueProf){
  const baseChaos = ctx.chaos || 5;
  const varc      = ctx.variance || 5;
  const tempo     = ctx.tempo || 5;

  const deltaElo = (H.elo - A.elo)/400;
  const eloChaos = Math.abs(deltaElo)*1.1;

  let modeFactor = 0;
  const m = (ctx.mode || "").toLowerCase();
  if(m==="derby")      modeFactor+=1.1;
  else if(m==="final") modeFactor+=1.0;
  else if(m==="title") modeFactor+=0.9;
  else if(m==="relegation") modeFactor+=0.95;
  else if(m==="cup")   modeFactor+=0.5;
  else if(m==="friendly") modeFactor-=0.8;

  let stageFactor = 0;
  if(ctx.stage==="early") stageFactor+=0.2;
  if(ctx.stage==="late")  stageFactor+=0.5;

  const possGap  = Math.abs(H.poss - A.poss)/10;
  const tiltChaos= possGap*0.25;

  let score =
    baseChaos*0.4 +
    varc*0.25 +
    tempo*0.15 +
    modeFactor*0.8 +
    stageFactor*0.5 +
    leagueProf.tempoBias*0.6 +
    eloChaos*0.8 +
    tiltChaos;

  return clamp(score/2.3,1,10);
}

/* ============================================================
   ✦ Core Builder v100 APEX
   Menghitung:
   - atkH, atkA
   - defH, defA
   - edtH, edtA
   - λH_core, λA_core (belum di-adjust context)
============================================================== */
function core_build_v100_apex(H,A){
  const atkH = attackStrength_v6_apex(H);
  const atkA = attackStrength_v6_apex(A);

  const defH = xdef_v5_apex(H);
  const defA = xdef_v5_apex(A);

  const edtH = edt_v3_apex(H);
  const edtA = edt_v3_apex(A);

  const lambdaH_core = lambda_v100_apex(atkH,defA,edtH,edtA);
  const lambdaA_core = lambda_v100_apex(atkA,defH,edtA,edtH);

  return {
    atkH, atkA,
    defH, defA,
    edtH, edtA,
    lambdaH_core, lambdaA_core
  };
}

/* ============================================================
   PART 4 v100 APEX SELESAI
   Berikutnya (PART 5):
   • Context Adjust (Availability, ELO, H2H, Weather)
   • Poisson v100
   • Monte Carlo 10K
   • analyze_v100() → output ke result_panel
   ============================================================ */
</script>
<script>
/* ============================================================
   v100 APEX — PART 5
   Context Adjust • Poisson v100 • Monte Carlo 10K
   analyze_v100() → Output Text
   ============================================================ */

/* ---------- H2H Parser ---------- */
function parseH2H_v100(raw){
  if(!raw) return {has:false,played:0,avgH:0,avgA:0,bal:0};
  const parts = raw.split(",");
  let sumH=0,sumA=0,cnt=0;
  parts.forEach(s=>{
    const t = s.trim().split("-");
    if(t.length===2){
      const h = parseFloat(t[0]);
      const a = parseFloat(t[1]);
      if(!isNaN(h) && !isNaN(a)){
        sumH+=h; sumA+=a; cnt++;
      }
    }
  });
  if(cnt===0) return {has:false,played:0,avgH:0,avgA:0,bal:0};
  const avgH = sumH/cnt;
  const avgA = sumA/cnt;
  const bal  = avgH-avgA;
  return {has:true,played:cnt,avgH,avgA,bal};
}

/* ---------- Availability / ELO / H2H / Context Adjust ---------- */
function availability_adjust_v100(lH,lA,H,A){
  const fH = clamp(0.85 + (H.avail/100)*0.15,0.85,1.10);
  const fA = clamp(0.85 + (A.avail/100)*0.15,0.85,1.10);
  return {lambdaH:lH*fH, lambdaA:lA*fA};
}

function elo_adjust_v100(lH,lA,H,A){
  const delta = clamp((H.elo - A.elo)/800,-0.20,0.20);
  const fH = 1 + delta;
  const fA = 1 - delta*0.9;
  return {lambdaH:lH*fH, lambdaA:lA*fA};
}

function h2h_adjust_v100(lH,lA,h2h){
  if(!h2h || !h2h.has) return {lambdaH:lH,lambdaA:lA};
  const adj = clamp(h2h.bal*0.03,-0.25,0.25);
  const fH  = 1 + adj*0.08;
  const fA  = 1 - adj*0.08;
  return {lambdaH:lH*fH,lambdaA:lA*fA};
}

function context_scale_v100(lH,lA,ctx,leagueProf,chaos){
  const tempo = ctx.tempo || 5;
  const varc  = ctx.variance || 5;

  let fTempo  = 1 + (tempo-5)*0.03;
  let fChaos  = 1 + (chaos-5)*0.02;
  let fVar    = 1 + (varc-5)*0.015;
  let fLeague = leagueProf.xgScale;
  let fDef    = 1 - leagueProf.defTight*0.08;

  let fWeather = 1;
  const w = (ctx.weather || "").toLowerCase();
  if(w==="rain")       fWeather -= 0.04;
  else if(w==="heavy_rain") fWeather -= 0.09;
  else if(w==="snow")  fWeather -= 0.11;
  else if(w==="windy") fWeather -= 0.05;

  let f = fTempo * fChaos * fVar * fLeague * fDef * fWeather;
  f = clamp(f,0.75,1.40);
  return {lambdaH:lH*f, lambdaA:lA*f};
}

/* ---------- Poisson v100 ---------- */
function factorial_v100(n){
  if(n<=1) return 1;
  let r=1;
  for(let i=2;i<=n;i++) r*=i;
  return r;
}

function poisson_v100(lambda,k){
  lambda = Math.max(lambda,0.000001);
  return Math.pow(lambda,k)*Math.exp(-lambda)/factorial_v100(k);
}

function prob3way_v100(lH,lA,maxG=10){
  let pH=0,pD=0,pA=0;
  for(let i=0;i<=maxG;i++){
    for(let j=0;j<=maxG;j++){
      const p = poisson_v100(lH,i)*poisson_v100(lA,j);
      if(i>j) pH+=p; else if(i===j) pD+=p; else pA+=p;
    }
  }
  return {pH,pD,pA};
}

function ou_prob_v100(lH,lA,line,maxG=10){
  let over=0,under=0;
  for(let i=0;i<=maxG;i++){
    for(let j=0;j<=maxG;j++){
      const s=i+j;
      const p = poisson_v100(lH,i)*poisson_v100(lA,j);
      if(s>line) over+=p; else under+=p;
    }
  }
  return {over,under};
}

function btts_prob_v100(lH,lA,maxG=10){
  let yes=0,no=0;
  for(let i=0;i<=maxG;i++){
    for(let j=0;j<=maxG;j++){
      const p = poisson_v100(lH,i)*poisson_v100(lA,j);
      if(i>0 && j>0) yes+=p; else no+=p;
    }
  }
  return {yes,no};
}

function top_scores_v100(lH,lA,maxG=6){
  const arr=[];
  for(let i=0;i<=maxG;i++){
    for(let j=0;j<=maxG;j++){
      const p = poisson_v100(lH,i)*poisson_v100(lA,j);
      arr.push({score:`${i}-${j}`,prob:p});
    }
  }
  arr.sort((a,b)=>b.prob-a.prob);
  return arr.slice(0,8);
}

/* ---------- Monte Carlo v100 (10.000-run) ---------- */
function build_cdf_v100(lambda,maxG){
  const cdf=[];
  let cum=0;
  for(let k=0;k<=maxG;k++){
    const p=poisson_v100(lambda,k);
    cum+=p;
    cdf.push(cum);
  }
  if(cdf[cdf.length-1]<0.9999) cdf[cdf.length-1]=1;
  return cdf;
}

function sample_cdf_v100(cdf){
  const u=Math.random();
  for(let i=0;i<cdf.length;i++){
    if(u<=cdf[i]) return i;
  }
  return cdf.length-1;
}

function montecarlo_v100(lH,lA,runs){
  const N = runs || 10000;
  const maxG = 8;
  const cdfH = build_cdf_v100(lH,maxG);
  const cdfA = build_cdf_v100(lA,maxG);

  let winH=0,winA=0,draw=0;
  let sumH=0,sumA=0;
  let over15=0,over25=0,over35=0,over45=0;
  let bttsY=0,bttsN=0;
  const scoreCnt={};

  for(let n=0;n<N;n++){
    const gH=sample_cdf_v100(cdfH);
    const gA=sample_cdf_v100(cdfA);
    sumH+=gH; sumA+=gA;

    if(gH>gA) winH++; else if(gH<gA) winA++; else draw++;

    const total = gH+gA;
    if(total>1.5) over15++;
    if(total>2.5) over25++;
    if(total>3.5) over35++;
    if(total>4.5) over45++;

    if(gH>0 && gA>0) bttsY++; else bttsN++;

    const key = gH+"-"+gA;
    scoreCnt[key]=(scoreCnt[key]||0)+1;
  }

  const scores = Object.keys(scoreCnt).map(k=>({
    score:k,
    prob:scoreCnt[k]/N
  })).sort((a,b)=>b.prob-a.prob).slice(0,8);

  return {
    runs:N,
    avgH:sumH/N,
    avgA:sumA/N,
    pH:winH/N,
    pD:draw/N,
    pA:winA/N,
    ou:{
      "1.5":over15/N,
      "2.5":over25/N,
      "3.5":over35/N,
      "4.5":over45/N
    },
    btts:{
      yes:bttsY/N,
      no:bttsN/N
    },
    scores
  };
}

/* ---------- Multi Scenario v100 ---------- */
function multi_scenario_v100(lH,lA,leagueProf,chaos){
  const baseH = clamp(lH,0.05,5.5);
  const baseA = clamp(lA,0.05,5.5);

  const chaosNorm = (chaos-5)/5; // -0.8 .. +1
  const lowFactor  = clamp(1 - 0.3 - chaosNorm*0.25 - leagueProf.defTight*0.3,0.45,0.95);
  const highFactor = clamp(1 + 0.3 + chaosNorm*0.35 + leagueProf.tempoBias*0.2,1.05,1.8);
  const extFactor  = clamp(highFactor + chaosNorm*0.25,1.1,2.2);

  return {
    base:{H:baseH,A:baseA},
    low :{H:baseH*lowFactor,A:baseA*lowFactor},
    high:{H:baseH*highFactor,A:baseA*highFactor},
    extreme:{H:baseH*extFactor,A:baseA*extFactor}
  };
}

function scenario_summary_v100(lH,lA){
  const p3 = prob3way_v100(lH,lA);
  const ou25 = ou_prob_v100(lH,lA,2.5);
  const bt = btts_prob_v100(lH,lA);
  return {
    lambdaH:lH,
    lambdaA:lA,
    pH:p3.pH, pD:p3.pD, pA:p3.pA,
    ouOver:ou25.over, ouUnder:ou25.under,
    bttsY:bt.yes, bttsN:bt.no
  };
}

/* ---------- Reliability / Risk / Collapse ---------- */
function reliability_v100(T,chaos){
  const atkCore = ( (T.xthreat||5) + (T.f3t||5) + (T.build||5) + (T.finish||5) )/4;
  const defCore = ( (T.deflvl||5)+(T.lb||5)+(T.gk||5)+(T.pressres||5) )/4;
  const stab    = T.stab || 5;
  let r = atkCore*0.35 + defCore*0.35 + stab*0.25 - chaos*0.15;
  return clamp(r/1.3,1,10);
}

function risk_match_v100(H,A,chaos){
  const tiltPoss = Math.abs(H.poss - A.poss)/10;
  const waveGap  = Math.abs(H.wave - A.wave)/2;
  let r = chaos*0.45 + tiltPoss*0.35 + waveGap*0.20;
  return clamp(r/2.1,1,10);
}

function collapse_v100(T,risk){
  let c = (10-(T.deflvl||5))*0.35 + (10-(T.lb||5))*0.3 + risk*0.35;
  return clamp(c/2.4,1,10);
}

/* ---------- Format helper ---------- */
function fmtPct_v100(x){
  if(isNaN(x)) return "-";
  return (x*100).toFixed(1)+"%";
}
function fmtDec_v100(x,d){
  if(isNaN(x)) return "-";
  return x.toFixed(d==null?3:d);
}

function match_profile_text_v100(ctx,leagueProf,chaos,H,A){
  let modeTxt="League match";
  const m=(ctx.mode||"").toLowerCase();
  if(m==="cup") modeTxt="Cup / knock-out";
  else if(m==="final") modeTxt="Final";
  else if(m==="derby") modeTxt="Derby";
  else if(m==="title") modeTxt="Title race";
  else if(m==="relegation") modeTxt="Relegation battle";
  else if(m==="intl") modeTxt="International";
  else if(m==="friendly") modeTxt="Friendly";

  let tempoTxt="moderate";
  if(ctx.tempo<=4) tempoTxt="slow / controlled";
  else if(ctx.tempo>=7) tempoTxt="fast / high tempo";

  let chaosTxt="balanced";
  if(chaos<=4) chaosTxt="structured";
  else if(chaos>=7) chaosTxt="high variance";

  let possTxt="balanced";
  if(H.poss >= A.poss+8) possTxt="Home more ball";
  else if(A.poss >= H.poss+8) possTxt="Away more ball";

  return `Mode: ${modeTxt} · League: ${leagueProf.name} · Tempo: ${tempoTxt} · Chaos: ${chaosTxt} · Possession: ${possTxt}`;
}

/* ---------- ANALYZE v100 APEX ---------- */
function analyze_v100(){
  const H   = parseTeam_v100("h");
  const A   = parseTeam_v100("a");
  const ctx = parseContext_v100();
  const h2h = parseH2H_v100(ctx.h2h_raw);

  const core = core_build_v100_apex(H,A);
  let lambdaH = core.lambdaH_core;
  let lambdaA = core.lambdaA_core;

  const leagueProf = league_profile_v100(ctx);
  const chaos      = deep_chaos_v7_apex(ctx,H,A,leagueProf);

  // Availability
  let adj = availability_adjust_v100(lambdaH,lambdaA,H,A);
  lambdaH = adj.lambdaH; lambdaA = adj.lambdaA;

  // ELO
  adj = elo_adjust_v100(lambdaH,lambdaA,H,A);
  lambdaH = adj.lambdaH; lambdaA = adj.lambdaA;

  // H2H
  adj = h2h_adjust_v100(lambdaH,lambdaA,h2h);
  lambdaH = adj.lambdaH; lambdaA = adj.lambdaA;

  // Context (league, weather, tempo, chaos, variance)
  adj = context_scale_v100(lambdaH,lambdaA,ctx,leagueProf,chaos);
  lambdaH = adj.lambdaH; lambdaA = adj.lambdaA;

  lambdaH = clamp(lambdaH,0.05,5.5);
  lambdaA = clamp(lambdaA,0.05,5.5);

  // Analytic
  const p3    = prob3way_v100(lambdaH,lambdaA);
  const ou15  = ou_prob_v100(lambdaH,lambdaA,1.5);
  const ou25  = ou_prob_v100(lambdaH,lambdaA,2.5);
  const ou35  = ou_prob_v100(lambdaH,lambdaA,3.5);
  const ou45  = ou_prob_v100(lambdaH,lambdaA,4.5);
  const btts  = btts_prob_v100(lambdaH,lambdaA);
  const topSc = top_scores_v100(lambdaH,lambdaA);

  // Monte Carlo 10K
  const mc = montecarlo_v100(lambdaH,lambdaA,10000);

  // Scenario
  const scen    = multi_scenario_v100(lambdaH,lambdaA,leagueProf,chaos);
  const sBase   = scenario_summary_v100(scen.base.H,scen.base.A);
  const sLow    = scenario_summary_v100(scen.low.H,scen.low.A);
  const sHigh   = scenario_summary_v100(scen.high.H,scen.high.A);
  const sExt    = scenario_summary_v100(scen.extreme.H,scen.extreme.A);

  // Reliability & risk
  const relH = reliability_v100(H,chaos);
  const relA = reliability_v100(A,chaos);
  const risk = risk_match_v100(H,A,chaos);
  const colH = collapse_v100(H,risk);
  const colA = collapse_v100(A,risk);

  // Text assemble
  const panel = document.getElementById("result_panel");
  if(!panel) return;

  const hName = H.name || "HOME";
  const aName = A.name || "AWAY";

  const profLine = match_profile_text_v100(ctx,leagueProf,chaos,H,A);

  const h2hLine = h2h.has
    ? `H2H: ${h2h.played} match · Avg Home ${h2h.avgH.toFixed(2)} · Avg Away ${h2h.avgA.toFixed(2)} · Balance ${h2h.bal.toFixed(2)}`
    : `H2H: tidak ada data / kosong`;

  const scoreAnalyticLine = topSc
    .map(s=>`${s.score} (${fmtPct_v100(s.prob)})`).join(" · ") || "-";

  const scoreMCLine = mc.scores
    .map(s=>`${s.score} (${fmtPct_v100(s.prob)})`).join(" · ") || "-";

  const header =
`${hName} vs ${aName}
League: ${leagueProf.name}
${profLine}

λ CORE (stat-only, sebelum context):
  λ Home core : ${fmtDec_v100(core.lambdaH_core,3)}
  λ Away core : ${fmtDec_v100(core.lambdaA_core,3)}

λ FINAL v100 APEX:
  λ Home final: ${fmtDec_v100(lambdaH,3)}
  λ Away final: ${fmtDec_v100(lambdaA,3)}

`;

  const analyticBlock =
`=== Poisson Analytic v100 (netral, tanpa odds) ===

3-Way:
  Home : ${fmtPct_v100(p3.pH)}
  Draw : ${fmtPct_v100(p3.pD)}
  Away : ${fmtPct_v100(p3.pA)}

Over/Under (analytic):
  O/U 1.5 : Over ${fmtPct_v100(ou15.over)} · Under ${fmtPct_v100(ou15.under)}
  O/U 2.5 : Over ${fmtPct_v100(ou25.over)} · Under ${fmtPct_v100(ou25.under)}
  O/U 3.5 : Over ${fmtPct_v100(ou35.over)} · Under ${fmtPct_v100(ou35.under)}
  O/U 4.5 : Over ${fmtPct_v100(ou45.over)} · Under ${fmtPct_v100(ou45.under)}

BTTS (analytic):
  Yes : ${fmtPct_v100(btts.yes)}
  No  : ${fmtPct_v100(btts.no)}

Top scorelines (analytic):
  ${scoreAnalyticLine}
`;

  const mcBlock =
`=== Monte Carlo v100 (10.000 simulasi) ===

Rata-rata gol:
  Home : ${fmtDec_v100(mc.avgH,2)}
  Away : ${fmtDec_v100(mc.avgA,2)}

3-Way (simulasi):
  Home : ${fmtPct_v100(mc.pH)}
  Draw : ${fmtPct_v100(mc.pD)}
  Away : ${fmtPct_v100(mc.pA)}

Over/Under (simulasi):
  O/U 1.5 : Over ${fmtPct_v100(mc.ou["1.5"])}
  O/U 2.5 : Over ${fmtPct_v100(mc.ou["2.5"])}
  O/U 3.5 : Over ${fmtPct_v100(mc.ou["3.5"])}
  O/U 4.5 : Over ${fmtPct_v100(mc.ou["4.5"])}

BTTS (simulasi):
  Yes : ${fmtPct_v100(mc.btts.yes)}
  No  : ${fmtPct_v100(mc.btts.no)}

Top scorelines (simulasi):
  ${scoreMCLine}
`;

  function scenText(name,s){
    return `[${name}]
  λ H/A : ${fmtDec_v100(s.lambdaH,3)} / ${fmtDec_v100(s.lambdaA,3)}
  1X2   : Home ${fmtPct_v100(s.pH)} · Draw ${fmtPct_v100(s.pD)} · Away ${fmtPct_v100(s.pA)}
  O/U2.5: Over ${fmtPct_v100(s.ouOver)} · Under ${fmtPct_v100(s.ouUnder)}
  BTTS  : Yes ${fmtPct_v100(s.bttsY)} · No ${fmtPct_v100(s.bttsN)}
`;
  }

  const scenarioBlock =
`=== Multi Scenario v100 (tanpa condong) ===

${scenText("BASE",sBase)}
${scenText("LOW-EVENT (lebih tertutup)",sLow)}
${scenText("HIGH-EVENT (lebih terbuka)",sHigh)}
${scenText("EXTREME (sangat terbuka / chaos)",sExt)}
`;

  const extraBlock =
`=== Reliability • Risk • Collapse ===

Reliability (1–10):
  ${hName} : ${fmtDec_v100(relH,2)}
  ${aName} : ${fmtDec_v100(relA,2)}

Match risk level (1–10):
  Risk : ${fmtDec_v100(risk,2)}

Collapse potential (1–10):
  ${hName} : ${fmtDec_v100(colH,2)}
  ${aName} : ${fmtDec_v100(colA,2)}
`;

  const ctxBlock =
`=== H2H & Notes ===
${h2hLine}

Notes:
${ctx.note || "-"}
`;

  panel.textContent = header + "\n" +
    analyticBlock + "\n" +
    mcBlock + "\n" +
    scenarioBlock + "\n" +
    extraBlock + "\n" +
    ctxBlock;

  const resultPkg = {
    H,A,ctx,
    core,
    leagueProf,
    chaos,
    lambdaH,lambdaA,
    p3,
    ou:{ou15,ou25,ou35,ou45},
    btts,
    topSc,
    mc,
    scen,
    scenSummary:{base:sBase,low:sLow,high:sHigh,extreme:sExt},
    rel:{H:relH,A:relA},
    risk,
    collapse:{H:colH,A:colA},
    h2h
  };

  // Kirim ke visual engine kalau ada (Part 6)
  try {
    if(typeof visuals_v100 === "function"){
      visuals_v100(resultPkg);
    }
  } catch(e){
    console.warn("visuals_v100 error:",e);
  }

  return resultPkg;
}

/* ---------- Bind tombol ANALYZE ---------- */
const btnAnalyze = document.getElementById("btn_analyze_v100");
if(btnAnalyze){
  btnAnalyze.addEventListener("click", analyze_v100);
}
</script>
<script>
/* ============================================================
   v100 APEX — PART 6
   VISUAL ENGINE (Radar, Wave, Heatline, Wheel, Bars)
   ============================================================ */

/* ============================================================
   Utility
============================================================ */
function drawCircle(ctx,x,y,r,color){
  ctx.beginPath();
  ctx.arc(x,y,r,0,Math.PI*2);
  ctx.strokeStyle=color;
  ctx.stroke();
}

function map(val,inMin,inMax,outMin,outMax){
  return outMin + ( (val-inMin)/(inMax-inMin) )*(outMax-outMin);
}

/* ============================================================
   RADAR CHART
============================================================ */
function radar_v100(canvas,data){
  if(!canvas) return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width;
  const h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const cx=w/2, cy=h/2;
  const R=Math.min(w,h)/2.3;

  const keys=[
    "atk","def","trans","build","finish","gk"
  ];

  const vals=[
    data.atk, data.def, data.trans,
    data.build, data.finish, data.gk
  ];

  const angleStep=(Math.PI*2)/keys.length;

  ctx.strokeStyle="#666";
  ctx.lineWidth=1;

  // web background
  for(let r=1;r<=5;r++){
    ctx.beginPath();
    for(let i=0;i<keys.length;i++){
      const ang=i*angleStep - Math.PI/2;
      const rr = (R/5)*r;
      const x=cx + rr*Math.cos(ang);
      const y=cy + rr*Math.sin(ang);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.stroke();
  }

  // labels
  ctx.fillStyle="#ccc";
  ctx.font="13px sans-serif";
  for(let i=0;i<keys.length;i++){
    const ang=i*angleStep - Math.PI/2;
    const x=cx + (R+18)*Math.cos(ang);
    const y=cy + (R+18)*Math.sin(ang);
    ctx.fillText(keys[i].toUpperCase(),x-10,y+3);
  }

  // data polygon
  ctx.beginPath();
  ctx.strokeStyle="#00f7ff";
  ctx.lineWidth=2;

  for(let i=0;i<vals.length;i++){
    const ang=i*angleStep - Math.PI/2;
    const r = map(vals[i],0,10,0,R);
    const x=cx + r*Math.cos(ang);
    const y=cy + r*Math.sin(ang);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.stroke();
}

/* ============================================================
   WAVE MOMENTUM GRAPH
============================================================ */
function wavechart_v100(canvas,homeWave,awayWave){
  if(!canvas) return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.strokeStyle="#555";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(0,h/2);
  ctx.lineTo(w,h/2);
  ctx.stroke();

  const N=90;
  const hx=h/2;
  ctx.lineWidth=2;

  // Home
  ctx.strokeStyle="#3bc9ff";
  ctx.beginPath();
  for(let m=0;m<=N;m++){
    const wave=homeWave;
    const y = hx - map(wave,1,10,0,h/2.3);
    const x = (m/N)*w;
    if(m===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // Away
  ctx.strokeStyle="#ff8a8a";
  ctx.beginPath();
  for(let m=0;m<=N;m++){
    const wave=awayWave;
    const y = hx + map(wave,1,10,0,h/2.3);
    const x = (m/N)*w;
    if(m===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

/* ============================================================
   HEATLINE BAR (Balance Attack - Defense - Possession)
============================================================ */
function heatline_v100(canvas,bal){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.fillStyle="#333";
  ctx.fillRect(0,h/3,w,h/3);

  const mid=w/2;

  let x = map(bal,-10,10,0,w);
  ctx.fillStyle = bal>=0 ? "#3bc9ff" : "#ff7979";
  ctx.fillRect(mid, h/3, x-mid, h/3);
}

/* ============================================================
   STRENGTH BAR (Attack / Defense Comparison)
============================================================ */
function bar_v100(canvas,valH,valA,label){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const maxVal=Math.max(valH,valA,1);
  const bh=h/3;

  ctx.fillStyle="#3bc9ff";
  ctx.fillRect(0,0, map(valH,0,maxVal,0,w), bh);

  ctx.fillStyle="#ff6b6b";
  ctx.fillRect(0,bh*2, map(valA,0,maxVal,0,w), bh);

  ctx.fillStyle="#ccc";
  ctx.font="14px sans-serif";
  ctx.fillText(label+" (H/A): "+valH.toFixed(2)+" / "+valA.toFixed(2),10,bh*1.6);
}

/* ============================================================
   CHAOS BAR
============================================================ */
function chaosbar_v100(canvas,chaos){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.fillStyle="#444";
  ctx.fillRect(0,h/4,w,h/2);

  const x = map(chaos,1,10,0,w);
  ctx.fillStyle = chaos>=6 ? "#ff8a00" : "#3bc9ff";
  ctx.fillRect(0,h/4,x,h/2);
}

/* ============================================================
   RELIABILITY / RISK DIAL
============================================================ */
function dial_v100(canvas,val,color){
  if(!canvas) return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const cx=w/2, cy=h/2;
  const r=Math.min(w,h)/3;

  ctx.strokeStyle="#555";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.arc(cx,cy,r,Math.PI*0.75,Math.PI*0.25,true);
  ctx.stroke();

  const ang = map(val,1,10,Math.PI*0.75,Math.PI*0.25);
  const x=cx + r*Math.cos(ang);
  const y=cy + r*Math.sin(ang);

  ctx.strokeStyle=color;
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(x,y);
  ctx.stroke();

  ctx.fillStyle="#ccc";
  ctx.font="14px sans-serif";
  ctx.fillText("Val: "+val.toFixed(2),cx-20,cy+r+20);
}

/* ============================================================
   SCORE WHEEL
============================================================ */
function scorewheel_v100(canvas,scores){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const cx=w/2, cy=h/2;
  const r=Math.min(w,h)/2.3;

  const seg=scores.length;
  const step=(Math.PI*2)/seg;

  for(let i=0;i<seg;i++){
    const ang1=i*step;
    const ang2=(i+1)*step;
    const p=scores[i].prob;

    const c=Math.floor(map(p,0,0.3,180,255));
    ctx.fillStyle=`rgb(${255-c},${c},${120})`;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,ang1,ang2);
    ctx.closePath();
    ctx.fill();
  }

  ctx.fillStyle="#eee";
  ctx.font="13px sans-serif";
  let ty=20;
  for(let s of scores){
    ctx.fillText(s.score+" ("+(s.prob*100).toFixed(1)+"%)",10,ty);
    ty+=15;
  }
}

/* ============================================================
   MAIN VISUAL ASSEMBLER
============================================================ */
function visuals_v100(pkg){
  const H=pkg.H;
  const A=pkg.A;

  const atkH=pkg.core ? pkg.core.atkH : 5;
  const atkA=pkg.core ? pkg.core.atkA : 5;

  const defH=pkg.core ? pkg.core.defH : 5;
  const defA=pkg.core ? pkg.core.defA : 5;

  const transH=H.trans||5, transA=A.trans||5;
  const buildH=H.build||5, buildA=A.build||5;
  const finH=H.finish||5, finA=A.finish||5;
  const gkH=H.gk||5, gkA=A.gk||5;

  /* Radar */
  radar_v100(
    document.getElementById("radar_home"),
    {atk:atkH,def:defH,trans:transH,build:buildH,finish:finH,gk:gkH}
  );

  radar_v100(
    document.getElementById("radar_away"),
    {atk:atkA,def:defA,trans:transA,build:buildA,finish:finA,gk:gkA}
  );

  /* Wave */
  wavechart_v100(
    document.getElementById("wave_chart"),
    H.wave||5,
    A.wave||5
  );

  /* Heatline */
  const bal = (atkH - atkA)*0.7 + (H.poss - A.poss)*0.15 + (defA - defH)*0.15;
  heatline_v100(
    document.getElementById("heatline"),
    bal
  );

  /* Strength bars */
  bar_v100(document.getElementById("bar_atk"), atkH, atkA, "Attack Strength");
  bar_v100(document.getElementById("bar_def"), defH, defA, "Defense Strength");

  /* Chaos */
  chaosbar_v100(
    document.getElementById("chaos_bar"),
    pkg.chaos
  );

  /* Dials */
  dial_v100(document.getElementById("dial_relH"), pkg.rel.H, "#3bc9ff");
  dial_v100(document.getElementById("dial_relA"), pkg.rel.A, "#ff6b6b");
  dial_v100(document.getElementById("dial_risk"), pkg.risk, "#ffaa00");

  /* Score Wheel (MC) */
  scorewheel_v100(
    document.getElementById("score_wheel"),
    pkg.mc.scores
  );
}

/* ============================================================
   END PART 6 v100
   Visual Engine selesai, independent & clean.
============================================================ */
</script>
<script>
/* ============================================================
   v100 APEX — PART 7
   ULTRA VISUAL EXTRA:
   • Zone Threat Map
   • Passing Lane Map
   • Chaos Mesh
   • Defensive Heat Mesh
   • Attack Flow Vector Map
   ============================================================ */

/* ========== BASIC DRAW UTIL ========== */
function drawRect(ctx,x,y,w,h,color){
  ctx.fillStyle=color;
  ctx.fillRect(x,y,w,h);
}

function blendColor(base,alpha){
  return `rgba(${base},${alpha})`;
}

/* ============================================================
   ZONE THREAT MAP (Half-space, central, wide areas)
============================================================ */
function zonethreat_v100(canvas,H,A,pkg){
  if(!canvas) return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);

  // Zone weight: attack, f3, xThreat, wave, prog
  function zoneVal(T){
    return clamp(
      (T.atk || 5)*0.22 +
      (T.f3 || 5)*0.18 +
      (T.xthreat || 5)*0.22 +
      (T.wave || 5)*0.15 +
      (T.prog || 5)*0.10 +
      (T.trans || 5)*0.13,
      1,10
    );
  }

  const zH = zoneVal(H);
  const zA = zoneVal(A);

  // Field divided into: Left – Left HS – Center – Right HS – Right
  const zones = 5;
  const zoneW = w/zones;

  for(let i=0;i<zones;i++){
    const mid=(i===2);
    const hs = (i===1 || i===3);

    const valH = zH*(mid?1.05:(hs?0.97:0.9));
    const valA = zA*(mid?1.05:(hs?0.97:0.9));

    let diff = valH - valA; // positive = Home stronger in zone
    diff = clamp(diff,-8,8);

    const intensity = Math.abs(diff)/8;
    const alpha = map(intensity,0,1,0.15,0.75);

    const color = diff>=0 
      ? `rgba(50,200,255,${alpha})`
      : `rgba(255,100,100,${alpha})`;

    drawRect(ctx,i*zoneW,0,zoneW,h,color);
  }

  ctx.strokeStyle="#999";
  for(let i=0;i<=zones;i++){
    ctx.beginPath();
    ctx.moveTo(i*zoneW,0);
    ctx.lineTo(i*zoneW,h);
    ctx.stroke();
  }
}

/* ============================================================
   PASSING LANE MAP (Home + Away)
============================================================ */
function passmap_v100(canvas,H,A){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  // Lanes: left, half-left, center, half-right, right
  const lanes=5;
  const lw=w/lanes;

  // Lane strength uses build, prog, pressres
  function laneStrength(T){
    return clamp(
      (T.build||5)*0.25 +
      (T.prog||5)*0.40 +
      (T.pressres||5)*0.35,
      1,10
    );
  }

  const lH=laneStrength(H);
  const lA=laneStrength(A);

  for(let i=0;i<lanes;i++){
    const tilt = (i===2)?1:(i===1||i===3?0.9:0.8);

    const sH = lH*tilt;
    const sA = lA*tilt;

    const diff = clamp(sH-sA,-7,7);
    const beta = Math.abs(diff)/7;
    const alpha = map(beta,0,1,0.18,0.7);

    const color = diff>=0
      ? `rgba(0,210,255,${alpha})`
      : `rgba(255,120,120,${alpha})`;

    drawRect(ctx,i*lw,0,lw,h,color);
  }

  ctx.strokeStyle="#777";
  for(let i=0;i<=lanes;i++){
    ctx.beginPath();
    ctx.moveTo(i*lw,0);
    ctx.lineTo(i*lw,h);
    ctx.stroke();
  }
}

/* ============================================================
   CHAOS MESH (shows volatility of match)
============================================================ */
function chaosmesh_v100(canvas,chaos){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const cellsX=12;
  const cellsY=6;
  const cw=w/cellsX;
  const ch=h/cellsY;

  for(let y=0;y<cellsY;y++){
    for(let x=0;x<cellsX;x++){
      const noise = Math.random()*0.6 + 0.4;
      const val = (chaos/10)*noise;
      const alpha = clamp(val,0.1,0.9);
      const col = `rgba(255,120,0,${alpha})`;
      drawRect(ctx,x*cw,y*ch,cw,ch,col);
    }
  }
}

/* ============================================================
   DEFENSIVE HEAT MESH (how dangerous areas are for each team)
============================================================ */
function defheat_v100(canvas,H,A){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const gridX=8, gridY=5;
  const gw=w/gridX, gh=h/gridY;

  // Danger uses: deflvl (inverse), shc, wave, collapse
  function danger(T){
    return clamp(
      (10-(T.deflvl||5))*0.35 +
      (T.shc||5)*0.25 +
      (10-(T.lb||5))*0.20 +
      (T.dm15||5)*0.20,
      1,10
    );
  }

  const dH=danger(H);
  const dA=danger(A);

  for(let j=0;j<gridY;j++){
    for(let i=0;i<gridX;i++){

      const laneFactor = 1 - Math.abs(i-(gridX/2))/5;
      const sectorH = dH*laneFactor;
      const sectorA = dA*laneFactor;

      const diff = clamp(sectorA-sectorH,-7,7); 
      const intensity = Math.abs(diff)/7;
      const alpha = map(intensity,0,1,0.15,0.75);

      const color = diff>=0
        ? `rgba(255,60,60,${alpha})`  
        : `rgba(50,200,255,${alpha})`;

      drawRect(ctx,i*gw,j*gh,gw,gh,color);
    }
  }
}

/* ============================================================
   ATTACK FLOW VECTOR MAP (Home → Away threat comparison)
============================================================ */
function attackflow_v100(canvas,H,A){
  if(!canvas)return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  function flowVal(T){
    return clamp(
      (T.atk||5)*0.35 +
      (T.build||5)*0.25 +
      (T.f3||5)*0.18 +
      (T.xthreat||5)*0.22,
      1,10
    );
  }

  const fH=flowVal(H);
  const fA=flowVal(A);

  let delta=fH-fA;
  delta = clamp(delta,-8,8);

  const cx=w/2, cy=h/2;
  const len = map(Math.abs(delta),0,8,20,w/2.3);

  ctx.lineWidth=4;
  ctx.strokeStyle = delta>=0 ? "#22caff" : "#ff7777";

  ctx.beginPath();
  if(delta>=0){
    ctx.moveTo(cx-len,cy);
    ctx.lineTo(cx+len,cy);
  } else {
    ctx.moveTo(cx+len,cy);
    ctx.lineTo(cx-len,cy);
  }
  ctx.stroke();

  ctx.beginPath();
  if(delta>=0){
    ctx.moveTo(cx+len,cy);
    ctx.lineTo(cx+len-15,cy-10);
    ctx.lineTo(cx+len-15,cy+10);
  } else {
    ctx.moveTo(cx-len,cy);
    ctx.lineTo(cx-len+15,cy-10);
    ctx.lineTo(cx-len+15,cy+10);
  }
  ctx.stroke();
}

/* ============================================================
   MAIN BIND
============================================================ */
function visuals_extra_v100(pkg){
  const H=pkg.H, A=pkg.A;

  zonethreat_v100(
    document.getElementById("zone_threat"),
    H,A,pkg
  );

  passmap_v100(
    document.getElementById("pass_map"),
    H,A
  );

  chaosmesh_v100(
    document.getElementById("chaos_mesh"),
    pkg.chaos
  );

  defheat_v100(
    document.getElementById("def_heat"),
    H,A
  );

  attackflow_v100(
    document.getElementById("attack_flow"),
    H,A
  );
}

/* ============================================================
   Auto-run inside visuals_v100()
============================================================ */
(function patchVisual(){
  const old = visuals_v100;
  visuals_v100 = function(pkg){
    try{ old(pkg); }catch(e){ console.warn(e); }
    try{ visuals_extra_v100(pkg); }catch(e){ console.warn(e); }
  };
})();
</script>
</body>
</html>
